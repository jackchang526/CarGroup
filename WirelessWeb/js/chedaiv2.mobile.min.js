var carloan=function(a){this.options={loading:!1,year:0,referprice:0,csid:0,carid:0,payrate:.3,loanmonths:36,page:1,pagelength:20,stateid:2,cityid:201,provdropdownlist:"#prov-list",citydropdownlist:"#city-list",orderfield:"MonthlyPayment",agentid:0},this.options.api_get_package_list="http://mai.bitauto.com/InsuranceAndLoan/Api/Loan/GetPackages/?downPaymentRate={4}&repaymentPeriod={5}&carModelId={2}&cityId={6}&orderBy={7}&pageNum={8}",this.options.api_get_unique_package="http://mai.bitauto.com/InsuranceAndLoan/Api/Loan/GetUniquePackagesByCompanyAndAppointFirst/?downPaymentRate={4}&repaymentPeriod={5}&carModelId={2}&cityId={6}&orderBy={7}&pageNum={8}&packageId={3}",this.options.api_get_package="http://mai.bitauto.com/InsuranceAndLoan/Api/Loan/GetPackageWithApplicationCount/?packageId={3}&downPaymentRate={4}&carModelId={2}&cityId={6}",this.options.api_submit_apply="http://mai.bitauto.com/InsuranceAndLoan/Api/Loan/SubmitApplication/?callback=?",this.options.api_get_province_list="http://mai.bitauto.com/InsuranceAndLoan/Region/GetProvinces",this.options.api_get_city_list="http://mai.bitauto.com/InsuranceAndLoan/Region/GetCities?provinceid={0}",this.options.carlist_init_callback=!1,this.options.provinces_init_callback=!1,this.options.cities_init_callback=!1,this.options.before_load_callback=!1,this.options.after_load_callback=!1,this.options.load_failed_callback=!1,this.options.single_select=!1,this.options=$.extend(this.options,a),this.data={},this.submiting=!1};carloan.common={format:function(a){var d,b=arguments,c=new Array;for(d=1;d<b.length;d++)c.push(b[d]);return a.replace(/\{(\d+)\}/g,function(a,b){return c[b]})}},carloan.errors={error1:{code:1,message:"未选择套餐"},error2:{code:2,message:"您已申请过该车型，请查看其他车型"},error4:{code:4,message:"保存失败"}},window.json_callback_for_prov=function(){},window.json_callback_for_city=function(){},window.json_callback_for_load=function(){},carloan.prototype.getcities=function(){var a=this,b=a.options;$.ajax({url:carloan.common.format(b.api_get_city_list,b.stateid),cache:!0,dataType:"jsonp",jsonpCallback:"json_callback_for_city",success:function(c){var e,f,g,d=$(b.citydropdownlist);if(d.length)for(e=[],e.push('<option value="0">请选择</option>'),f=0;f<c.length;f++)g=c[f],e.push(carloan.common.format('<option value="{0}">{1}</option>',g.ID,g.Name));d.html(e.join("")),d.change(function(){b.cityid=d.val(),a.load()}),b.cityid>0&&d.val(b.cityid),b.cities_init_callback&&a.options.cities_init_callback(a,c)},error:function(){},complete:function(){}})},carloan.prototype.init=function(){var a=this,b=a.options;"undefined"!=typeof bit_locationInfo&&bit_locationInfo.cityId&&(b.cityid=bit_locationInfo.cityId,b.stateid=Math.floor(b.cityid/100)),"undefined"!=typeof BitA&&BitA.DropDownList&&typeof BitA.DropDownList({container:{cartype:"cars"},include:{cartype:"1"},parent:{cartype:b.csid},dvalue:{cartype:b.carid},callback:{cartype:function(b){a.data.carlist=b,a.options.carlist_init_callback&&a.options.carlist_init_callback(a,b),a.load()}}}),$.ajax({url:b.api_get_province_list,cache:!0,dataType:"jsonp",jsonpCallback:"json_callback_for_prov",success:function(c){var e,f,g,d=$(b.provdropdownlist);if(d.length)for(e=[],e.push('<option value="0">请选择</option>'),f=0;f<c.length;f++)g=c[f],e.push(carloan.common.format('<option value="{0}">{1}</option>',g.ID,g.Name));d.html(e.join("")),b.stateid>0&&d.val(b.stateid),d.change(function(){b.stateid=d.val(),a.getcities()}),d.change(),b.provinces_init_callback&&a.options.provinces_init_callback(a,c)},error:function(){},complete:function(){}})},carloan.prototype.load=function(){var c,a=this,b=a.options;return b.before_load_callback&&b.before_load_callback(a),c=carloan.common.format(b.api_get_unique_package,b.csid,b.csspell,b.carid,b.agentid,b.payrate,b.loanmonths,b.cityid,b.orderfield,b.page),b.carid>0&&b.loanmonths>0&&b.payrate>0&&b.cityid>0?("undefined"!=typeof console&&console.log&&console.log(c),$.ajax({url:c,dataType:"jsonp",cache:!0,jsonpCallback:"json_callback_for_load",success:function(c){b.after_load_callback&&b.after_load_callback(a,c)},error:function(c,d,e){b.load_failed_callback&&b.load_failed_callback(a,c,d,e)},complete:function(){}}),void 0):(b.after_load_callback&&b.after_load_callback(a,null),void 0)},carloan.prototype.submitapply=function(a,b){var e,c=this,d=c.options;1==c.submiting&&alert("请等待上一次提交申请结束"),c.submiting=!0,$("body").css({cursor:"wait"}),e=$.extend({CityId:d.cityid,CarModelId:d.carid,Age:0,Ref:d.ref?d.ref:""},a||{}),$.ajax({url:d.api_submit_apply,data:e,dataType:"jsonp",success:function(a,c,d){b&&b.success&&b.success(a,c,d)},error:function(a,c,d){b&&b.error&&b.error(a,c,d)},complete:function(a,d){b&&b.complete&&b.complete(a,d),$("body").css({cursor:"default"}),c.submiting=!1}})},$(function(){var j,k,a={car_displayer:$("#m-show-item"),car_list_box:$("#car-list-box"),car_selector:$("#car-list"),load_layer:$("#load-layer"),cur_select_car:!1,cur_select_rate:!1,cur_select_month:!1},b=$("#empty-list"),c=$("#pack-list"),d=$("#pack-more"),e=$("#btn-show-more"),f=$("#btn-hide-more"),g=$("#btn-submit"),h="undefined"!=typeof chedai_config?chedai_config:{},i=function(){c.empty(),b.hide(),c.hide(),d.hide(),e.hide(),f.hide()};h.carlist_init_callback=function(b,c){var d,e,f,g;a.car_list_box.hide(),d=[],a.car_displayer.find("span").text("请选择");for(e in c)f=c[e],f.referprice>0&&d.push('<li name="car" data="'+f.id+'"><a href="#">'+f.goname+" "+f.name+"</a></li>");a.car_selector.html(d.join("")),a.car_selector.find("li").click(function(c){c.preventDefault(),c.stopPropagation(),a.cur_select_car&&a.cur_select_car.removeClass("current").html('<a href="#">'+a.cur_select_car.text()+"</a>"),a.cur_select_car=$(this).addClass("current").html($(this).text()),a.car_displayer.find("span").text($(this).text()),a.car_list_box.hide(),a.car_displayer.find("b").hide(),b.options.carid=$(this).attr("data"),b.load()}),a.car_displayer.click(function(){var b="none"==a.car_list_box.css("display");b?(a.car_displayer.find("b").show(),a.car_list_box.show()):(a.car_displayer.find("b").hide(),a.car_list_box.hide())}),$(document).click(function(b){b.stopPropagation(),b.target!=a.car_list_box[0]&&0===a.car_list_box.has(b.target).length&&b.target!=a.car_displayer[0]&&0===a.car_displayer.has(b.target).length&&(a.car_displayer.find("b").hide(),a.car_list_box.hide())}),a.car_selector.find("li[data]").length&&(g=a.car_selector.find('li[data="'+h.carid+'"]'),0==g.length&&(g=a.car_selector.find("li[data]:eq(0)"),j.options.carid=g.attr("data")),g.length&&(a.cur_select_car=g.addClass("current").html(g.text()),a.car_displayer.find("span").text(g.text())))},h.before_load_callback=function(){i(),a.load_layer.show()},h.after_load_callback=function(b,g){var h,i,j,k,l,m,n,o,p,q;if(a.load_layer.hide(),h=3,i=b.data.carlist["t"+b.options.carid],i&&($("#price-total").text(i.referprice+"万元"),$("#price-firstpay").text((i.referprice*b.options.payrate).toFixed(2)+"万元")),!g||0==g.Total)return $("#empty-list").show(),void 0;for(j=g.Packages,k={},l=0;l<g.Companies.length;l++)k[g.Companies[l].Id]=g.Companies[l];for(m=[],n=[],l=0;l<j.length;l++)o=j[l],p=carloan.common.format('<div class="m-cd-jxs-item"><div class="m-cd-jxs-item-check"><input name="selectedpak" type="'+(b.options.single_select?"radio":"checkbox")+'" value="{0}"></div>'+'<div class="m-cd-jxs-item-info">{6}'+'<p><span class="interese-box">总利息：<em>{3}</em></span> <span class="interese-box">月 供：<em>{4}</em></span></p>'+"</div>"+"</div>",o.Id,o.Name,o.PromotionTitle,0==o.TotalInterest?"0元":(1*o.TotalInterest/1e4).toFixed(2)+"万元",o.MonthlyPayment.toFixed(0)+"元",o.CompanyId,k[o.CompanyId]?k[o.CompanyId].Name:"",(o.InterestRate/.12).toFixed(2)),h>l?m.push(p):n.push(p);$("#empty-list").hide(),c.html(m.join("")).show(),d.html(n.join("")),q=$(".m-cd-jxs-item"),q.click(function(a){var c,d,e;a.stopPropagation(),c=$(this),d=c.find('input[name="selectedpak"]'),e=!1,d.length&&(e=d[0].checked,a.target!=d[0]&&d.attr("checked",!e),b.options.single_select&&q.removeClass("m-cd-jxs-item-selected"),a.target==d[0]&&e||a.target!=d[0]&&!e?c.addClass("m-cd-jxs-item-selected"):c.removeClass("m-cd-jxs-item-selected"))}),b.options.single_select?c.find(".m-cd-jxs-item:first").click():c.find(".m-cd-jxs-item").click(),n.length&&(e.show(),e.click(function(a){a.preventDefault(),d.show(),f.show(),e.hide()}),f.click(function(){event.preventDefault(),d.hide(),f.hide(),e.show()}))},h.load_failed_callback=function(){i(),$("#empty-list").show()},j=new carloan(h),j.init(),$("#month-list a").click(function(){event.preventDefault(),a.cur_select_month&&a.cur_select_month.removeClass("tj-sty-checked"),a.cur_select_month=$(this).addClass("tj-sty-checked"),j.options.loanmonths=$(this).attr("val"),j.load()}),h.loanmonths>0&&(k=$('#month-list a[val="'+h.loanmonths+'"]'),k.length&&(a.cur_select_month=k.addClass("tj-sty-checked"))),$("#rate-list a").click(function(){event.preventDefault(),a.cur_select_rate&&a.cur_select_rate.removeClass("tj-sty-checked"),a.cur_select_rate=$(this).addClass("tj-sty-checked"),j.options.payrate=$(this).attr("val"),j.load()}),h.payrate>0&&(k=$('#rate-list a[val="'+h.payrate+'"]'),k.length&&(a.cur_select_rate=k.addClass("tj-sty-checked"))),$("#form_chedai").submit(function(a){a.preventDefault()}),"undefined"!=typeof $.validator&&$.validator.addMethod&&($.validator.addMethod("chinese",function(a){return/^[\u4e00-\u9fa5]+$/.test(a)}),$.validator.addMethod("mobile",function(a,b){var c=a.length,d=/^1[3|4|5|8][0-9]\d{4,8}$/;return this.optional(b)||11==c&&d.test(a)},"请正确输入11位手机号码！"),$("#form_chedai").validate({debug:!0,onkeyup:!1,ignore:".ignore",errorElement:"div",errorContainer:$(".tishi"),errorPlacement:function(a,b){a.addClass("alert").appendTo($("#val-"+b.attr("name")))},rules:{name:{required:!0,rangelength:[2,8],chinese:!0},mobile:{required:!0,number:!0,mobile:!0},selectedpak:{required:!0}},messages:{name:{required:"请输入姓名！",rangelength:"请正确输入姓名！",chinese:"请正确输入姓名！"},mobile:{required:"请输入手机号！",number:"请正确输入手机号！",mobile:"请正确输入手机号！"},selectedpak:{required:"请选择金融机构！"}},submitHandler:function(){var b={Name:$('#form_chedai input[name="name"]').val(),Gender:$('#form_chedai input[name="gender"]:checked').val(),Mobile:$('#form_chedai input[name="mobile"]').val(),PackageIds:$('#form_chedai input[name="packids"]').val()};return j.submitapply(b,{success:function(a){var c,d,b="提交失败！";1==a||a.IsSuccess?b="提交成功！":carloan.errors["error"+a.ErrorCode]&&(b=carloan.errors["error"+a.ErrorCode].message),alert(b),(1==a||a.IsSuccess)&&(c=j.options,d="/"+c.csspell+"/",c.ref&&"app"==c.ref.substr(0,3)&&(d+="?end="+c.ref),window.location.href=d)}}),!1}})),g.click(function(a){a.preventDefault();var b=[];$('input[name="selectedpak"]:checked').each(function(){b.push(this.value)}),$('#form_chedai input[name="packids"]').val(b.join(",")),$("#form_chedai").submit()}),$("#prebtn").click(function(){var a="/"+j.options.csspell+"/";j.options.returnurl&&j.options.returnurl.length?a=j.options.returnurl:document.referrer&&document.referrer.length&&(a=document.referrer),window.location.href=a})});